---
title: Comparison of Bayesian and frequentist MMRM fits using example datasets
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    highlight: default
    toc: yes
    toc_float: yes
    number_sections: true 
vignette: |
  %\VignetteIndexEntry{Comparison of Bayesian and frequentist MMRM fits using example datasets}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown} 
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, eval=TRUE, include=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  prompt = TRUE,
  comment = NA,
  size = "scriptsize",
  fig.height = 5,
  fig.width = 6,
  dpi = 320,
  fig.align = "center",
  fig.path = "figures/"
)
```

# About {.unnumbered}

This vignette provides an exemplary comparison of Bayesian MMRM fits, 
obtained by `brms.mmrm::brm_model()`, 
and frequentist MMRM fits, obtained by `mmrm::mmrm()`, using an example dataset.

# Prerequisites

Load general packages:

```{r load_gen_pkgs, eval=TRUE, echo=TRUE, class.source = NULL}
packages <- c("tidyr", "dplyr", "tibble", "ggplot2", "gt", "gtsummary")
invisible(lapply(packages, library, character.only = TRUE))
```

Load MMRM packages:

```{r load_mmrm_pkgs, eval=TRUE, echo=TRUE, class.source = NULL}
library(brms.mmrm)
library(mmrm)
library(emmeans)
```

Set seed:

```{r set_seed, eval=TRUE, echo=TRUE, class.source = NULL}
set.seed(123L)
```


# Cervical dystonia data

A description of the `cdystonia` dataset and further references are given 
[here](https://hbiostat.org/data/repo/cdystonia).

In brief, the data are a subset from a multicenter, randomized controlled trial
of botulinum toxin type B in patients with cervical dystonia. 
The trial endpoint is the total score on Toronto Western Spasmodic Torticollis
Rating Scale (TWSTRS).

## Data pre-processing

Load dataset
```{r cdystonia1a, eval=TRUE, echo=TRUE, class.source = NULL}
data(cdystonia, package = "brms.mmrm")
```

Create and preprocess and MMRM dataset:
```{r cdystonia1b, eval=TRUE, echo=TRUE, class.source = NULL}
cdystonia <- brms.mmrm::brm_data(
  data = cdystonia,
  outcome = "twstrs",
  role = "response",
  group = "treat",
  time = "week",
  patient = "id",
  covariates = c("age", "sex"),
  level_control = "Placebo",
  level_baseline = "w00"
)
```

Convert to change from baseline:
```{r cdystonia1c, eval=TRUE, echo=TRUE, class.source = NULL}  
cdystonia <- cdystonia |>
  brms.mmrm::brm_data_change(name_change = "chg")
```

Further modifications:
```{r cdystonia1d, eval=TRUE, echo=TRUE, class.source = NULL} 
cdystonia <- dplyr::mutate(
  .data = cdystonia,
  id = factor(id),
  sex = factor(sex),
  treat = factor(treat),
  week = factor(week)
) |>
  dplyr::select(id, age, sex, baseline, treat, week, chg) |>
  dplyr::arrange(id, week) |>
  dplyr::filter(!is.na(chg))
```

First rows of dataset:
```{r cdystonia1e, eval=TRUE, echo=TRUE, class.source = NULL}
head(cdystonia) |> gt::gt()
```

## Descriptive statistics

```{r cdystonia2a, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
cdystonia |>
  dplyr::select(treat, age, sex, baseline) |>
  dplyr::distinct() |>
  gtsummary::tbl_summary(
    by = c(treat),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    )
  ) |>
  gtsummary::modify_caption("**Baseline characteristics.**")
```

```{r cdystonia2b, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
unique(cdystonia$week) |>
  sort() |>
  purrr::map(
    .f = ~ cdystonia |>
      dplyr::filter(week %in% .x) |>
      gtsummary::tbl_summary(
        by = treat,
        include = chg,
        type = chg ~ "continuous2",
        statistic = chg ~ c("{mean} ({sd})",
                            "{median} ({p25}, {p75})",
                            "{min}, {max}"),
        label = list(chg = paste("Visit ", .x))
      )
  ) |>
  gtsummary::tbl_stack(quiet = TRUE) |>
  gtsummary::modify_caption("**Change from baseline in total TWSTRS score.**")
```

```{r cdystonia_boxpl, eval=TRUE, echo=TRUE, fig.align='center', out.width="75%", fig.dim = c(8, 5), fig.fig.keep='all', fig.pos="!ht", fig.cap="Change from baseline in total TWSTRS score"}
cdystonia |>
  dplyr::group_by(treat) |>
  ggplot2::ggplot(aes(x = week, y = chg, fill = factor(treat))) +
  ggplot2::geom_boxplot() +
  ggplot2::labs(x = "Visit",
                y = "Change from baseline in total TWSTRS score",
                fill = "Treatment") +
  ggplot2::theme_bw()
```


## Fitting MMRMs

### Function `mmrm::mmrm()`

Fit model:
```{r cdystonia3a, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
cdystonia_mmrm <- mmrm::mmrm(
  formula = chg ~ baseline + week + age + treat : week + us(week | id),
  data = cdystonia
)
```

Summary of results:
```{r cdystonia3b, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
summary(cdystonia_mmrm)
```

### Function `brms.mmrm::brm_model()`

Model formula:
```{r cdystonia3c, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
cdystonia_formula <- brm_formula(
  data = cdystonia,
  intercept = TRUE,
  effect_baseline = TRUE,
  effect_group = FALSE,
  effect_time = TRUE,
  interaction_baseline = FALSE,
  interaction_group = TRUE,
  correlation = "unstructured"
)
print(cdystonia_formula)
```

Fit model (using multiple cores, if available, to limit runtime):
```{r cdystonia3d, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
n_cores <- ifelse(
  test = parallel::detectCores() > 1,
  yes = min(3, parallel::detectCores()),
  no = 1
)
cdystonia_brms.mmrm <- brm_model(
  data = cdystonia,
  formula = cdystonia_formula,
  iter = 1500,
  chains = max(1, n_cores),
  cores = n_cores,
  refresh = 0
)
```

```{r cdystonia3e, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
summary(cdystonia_brms.mmrm)
```


## Comparison 

...

<!--

# HSAUR3 data

## Data pre-processing

...

## Descriptive statistics
...

## Fitting MMRMs

...

## Comparison 

...


```{r figure1, eval=F, echo=F, fig.align='center', fig.width=8, fig.height=5, fig.keep='all', fig.pos="!ht", dev=c('pdf', 'png'), out.width="0.9\\textwidth", fig.cap="..."}
```

-->


# References {.unnumbered}

## Literature {.unnumbered}

...

<!--
&nbsp;

<div id="refs"></div>

&nbsp;
-->


## Session info {.unnumbered}

```{r citation_session, echo=TRUE, eval=TRUE, message=FALSE}
sessionInfo()
```
