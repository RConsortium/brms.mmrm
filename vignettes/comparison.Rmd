---
title: Comparison of Bayesian and frequentist MMRM fits using example datasets
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    highlight: default
    toc: yes
    toc_float: yes
    number_sections: true 
vignette: |
  %\VignetteIndexEntry{Comparison of Bayesian and frequentist MMRM fits using example datasets}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown} 
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, eval=T, include=F, warning=F, message=F}
rm(list = ls())
library(knitr)
knitr::opts_chunk$set( 
  echo = T, collapse = T, warning = F, message = F, 
  prompt = T, comment = NA, size = "scriptsize",
  fig.height = 5, fig.width = 6, dpi = 320, 
  fig.align = "center", fig.path="figures/"
  )
```

# About {.unnumbered}

This vignette provides an exemplary comparison of Bayesian MMRM fits, obtained by `brms.mmrm::brm_model()`, and frequentist MMRM fits, obtained by `mmrm::mmrm()`, using an example dataset.

# Prerequisites

Load general packages:

```{r load_gen_pkgs, eval=T, echo=T, class.source = NULL}
packages <- c("tidyr", "dplyr", "tibble", "ggplot2", "gt", "gtsummary")
invisible(lapply(packages, library, character.only = T))
```

Load packages providing example datasets:

```{r load_dat_pkgs, eval=T, echo=T, class.source = NULL}
library("Hmisc")
library("HSAUR3")
```

Load MMRM packages:

```{r load_mmrm_pkgs, eval=T, echo=T, class.source = NULL}
#if (!require("remotes")) {install.packages("remotes")}
#remotes::install_github("openpharma/brms.mmrm")
library(brms.mmrm)
#remotes::install_github("openpharma/mmrm")
library(mmrm)
library(emmeans)
```

Set seed:

```{r set_seed, eval=T, echo=T, class.source = NULL}
set.seed(123L)
```


# Cervical dystonia data

A description of the `cdystonia` dataset and further references are given [here](https://hbiostat.org/data/repo/cdystonia).

In brief, the data are a subset from a multicenter, randomized controlled trial of botulinum toxin type B in patients with cervical dystonia. The trial endpoint is the total score on Toronto Western Spasmodic Torticollis Rating Scale (TWSTRS).

<!--
Reduced to two groups.
TWSTRS-total scores from 109 patients with cervical dystonia: First 35 subjects
-->

## Data pre-processing 

```{r cdystonia1, eval=T, echo=T, class.source = NULL}
Hmisc::getHdata(cdystonia)
cdystonia1 <- cdystonia |>
  dplyr::filter(treat %in% c("10000U", "Placebo")) |> # restrict to two arms
  droplevels() |>
  dplyr::mutate_all(~{attr(., "label") <- NULL; .})|>
  dplyr::mutate(
    week = paste0("w", sprintf("%02d", week)), 
    id = paste0(site, "-", sprintf("%02d", id))
  ) |>
  dplyr::select(-c(site)) |>
  dplyr::arrange(id, week) |>
  brm_data( # create and preprocess MMRM dataset
    outcome = "twstrs",
    role = "response",
    group = "treat",
    time = "week",
    patient = "id",
    covariates = c("age", "sex"),
    level_control = "Placebo",
    level_baseline = "w00"
  ) |>
  brm_data_change(name_change = "delta") |> # convert to change from baseline
  dplyr::filter(!is.na(delta))
```

```{r cdystonia2, eval=T, echo=T, class.source = NULL}
head(cdystonia1) |> gt::gt()
```

## Descriptive statistics

```{r cdystonia3a, eval=T, echo=T, class.source = 'fold-hide'}
cdystonia1 |> dplyr::select(treat, age, sex, baseline) |> 
  dplyr::distinct() |>
  gtsummary::tbl_summary(
    by = c(treat),  
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)")
    ) |>
  gtsummary::modify_caption("**Baseline characteristics.**")
```

```{r cdystonia3b, eval=T, echo=T, class.source = 'fold-hide'}
unique(cdystonia1$week) |> sort() |>
  purrr::map(
    .f = ~ cdystonia1 |>
      dplyr::filter(week %in% .x)|>
      gtsummary::tbl_summary(
        by = treat, 
        include = delta,
        type = delta ~ "continuous2",
        statistic = delta ~ c("{mean} ({sd})", "{median} ({p25}, {p75})", "{min}, {max}"),
        label = list(delta = paste("Visit ", .x))
        )
    ) |>
  gtsummary::tbl_stack(quiet = T) |>
  gtsummary::modify_caption("**Change from baseline in total TWSTRS score.**")
```

```{r cdystonia_boxpl, eval=T, echo=T, fig.align='center', out.width="75%", fig.dim = c(8, 5), fig.fig.keep='all', fig.pos="!ht", fig.cap="Change from baseline in total TWSTRS score"}
cdystonia1 |> dplyr::group_by(treat) |>
  ggplot2::ggplot(aes(x = week, y = delta, fill = factor(treat))) +
  ggplot2::geom_boxplot() + 
  ggplot2::labs(
    x = "Visit", 
    y = "Change from baseline in total TWSTRS score", 
    fill = "Treatment" ) +
  ggplot2::theme_bw()
```


## Fitting MMRMs

### Function `mmrm::mmrm()`

```{r cdystonia4a, eval=T, echo=T, class.source = 'fold-hide'}
cdystonia2 <- cdystonia1 |>
  dplyr::mutate(
    treat = factor(treat),
    week = factor(week),
    id = factor(id)
  )
cdystonia_mmrm <- mmrm::mmrm(
  formula = delta ~ baseline + age + treat * week + us(week | id),
  data = cdystonia2
)
summary(cdystonia_mmrm)
```

### Function `brms.mmrm::brm_model()`

## Comparison 

...

<!--

# HSAUR3 data

## Data pre-processing

...

## Descriptive statistics
...

## Fitting MMRMs

...

## Comparison 

...


```{r figure1, eval=F, echo=F, fig.align='center', fig.width=8, fig.height=5, fig.keep='all', fig.pos="!ht", dev=c('pdf', 'png'), out.width="0.9\\textwidth", fig.cap="..."}
```

-->


# References {.unnumbered}

## Literature {.unnumbered}

...

<!--
&nbsp;

<div id="refs"></div>

&nbsp;
-->


## Session info {.unnumbered}

```{r citation_session, echo=T, eval=T, message=F}
sessionInfo()
```
