---
title: Exemplary comparison of Bayesian and frequentist MMRM fits
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    highlight: default
    toc: yes
    toc_float: yes
    number_sections: true 
vignette: >
  %\VignetteIndexEntry{Exemplary comparison of Bayesian and frequentist MMRM fits}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, eval=TRUE, include=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  prompt = TRUE,
  comment = NA,
  size = "scriptsize",
  fig.height = 5,
  fig.width = 6,
  dpi = 320,
  fig.align = "center",
  fig.path = "figures/"
)
```

# About {.unnumbered}

This vignette provides an exemplary comparison of Bayesian MMRM fits, 
obtained by `brms.mmrm::brm_model()`, and frequentist MMRM fits, 
obtained by `mmrm::mmrm()`.

# Prerequisites

Load required packages:

```{r load_gen_pkgs, eval=TRUE, echo=TRUE, class.source = NULL}
packages <- c(
  "dplyr",
  "ggplot2",
  "gt",
  "gtsummary",
  "purrr",
  "parallel",
  "brms.mmrm",
  "mmrm",
  "emmeans"
)
invisible(lapply(packages, library, character.only = TRUE))
```

Set seed:
```{r set_seed, eval=TRUE, echo=TRUE, class.source = NULL}
set.seed(123L)
```

# Data

## Pre-processing

Load the `fev_dat` dataset that is contained in `{mmrm}`:
```{r fev_dat_1, eval=TRUE, echo=TRUE, class.source = NULL}
data(fev_data, package = "mmrm")
```

Create and preprocess dataset for MMRM analysis:
```{r fev_dat_2, eval=TRUE, echo=TRUE, class.source = NULL}
fev_data <- fev_data |>
  mutate("FEV1_CHG" = FEV1 - FEV1_BL) # use change from baseline as endpoint
fev_data <- brm_data(
  data = fev_data,
  outcome = "FEV1_CHG",
  role = "change",
  group = "ARMCD",
  time = "AVISIT",
  patient = "USUBJID",
  baseline = "FEV1_BL",
  level_control = "PBO",
  covariates = c("RACE", "SEX")
) |>
  mutate(ARMCD = factor(ARMCD),
         AVISIT = factor(AVISIT))
```

First rows of dataset:
```{r fev_dat_3, eval=TRUE, echo=TRUE, class.source = NULL}
head(fev_data) |> gt()
```

## Descriptive statistics

Table of baseline characteristics:
```{r descr_1, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
fev_data |>
  select(ARMCD, USUBJID, SEX, RACE, FEV1_BL) |>
  distinct() |>
  select(-USUBJID) |>
  tbl_summary(
    by = c(ARMCD),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    )
  ) |>
  modify_caption("Baseline characteristics.")
```

Table of change from baseline in FEV1 over 52 weeks:
```{r descr_2, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
fev_data |>
  pull(AVISIT) |>
  unique() |>
  sort() |>
  purrr::map(
    .f = ~ fev_data |>
      filter(AVISIT %in% .x) |>
      tbl_summary(
        by = ARMCD,
        include = FEV1_CHG,
        type = FEV1_CHG ~ "continuous2",
        statistic = FEV1_CHG ~ c("{mean} ({sd})",
                                 "{median} ({p25}, {p75})",
                                 "{min}, {max}"),
        label = list(FEV1_CHG = paste("Visit ", .x))
      )
  ) |>
  tbl_stack(quiet = TRUE) |>
  modify_caption("Change from baseline in FEV1 over 4 visit time points.")
```

```{r descr_3, eval=TRUE, echo=TRUE, fig.align='center', out.width="75%", fig.dim = c(8, 5), fig.fig.keep='all', fig.pos="!ht", fig.cap="Change from baseline in FEV1 over 4 visit time points."}
fev_data |>
  group_by(ARMCD) |>
  ggplot(aes(x = AVISIT, y = FEV1_CHG, fill = factor(ARMCD))) +
  geom_hline(yintercept = 0, col = "grey", size = 1.2) +
  geom_boxplot(na.rm = TRUE) +
  labs(x = "Visit",
       y = "Change from baseline in FEV1",
       fill = "Treatment") +
  scale_fill_manual(values = c("darkgoldenrod2", "coral2")) +
  theme_bw()
```

# Fitting MMRMs

## Bayesian model

Model formula:
```{r bayes_mmrm_1, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
b_mmrm_formula <- brm_formula(
  data = fev_data,
  intercept = TRUE,
  effect_baseline = TRUE,
  effect_group = FALSE,
  effect_time = TRUE,
  interaction_baseline = FALSE,
  interaction_group = TRUE,
  correlation = "unstructured"
)
print(b_mmrm_formula)
```

Fit model (using multiple cores, if available, to avoid long runtime):
```{r bayes_mmrm_2a, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
n_cores <- ifelse(
  test = detectCores() > 1,
  yes = min(2, detectCores()),
  no = 1
)
```

```{r bayes_mmrm_2b, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
b_mmrm_fit <- brm_model(
  data = filter(fev_data, !is.na(FEV1_CHG)),
  formula = b_mmrm_formula,
  iter = 1500,
  chains = max(1, n_cores),
  cores = n_cores,
  refresh = 0
)
```

```{r bayes_mmrm_3, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
summary(b_mmrm_fit)
```


## Frequentist model

Fit model:
```{r freq_mmrm_1, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
f_mmrm_fit <- mmrm::mmrm(
  formula = FEV1_CHG ~ FEV1_BL + AVISIT + ARMCD:AVISIT + RACE + SEX +
    us(AVISIT | USUBJID),
  data = fev_data
)
```

Summary of results:
```{r freq_mmrm_2, eval=TRUE, echo=TRUE, class.source = 'fold-hide'}
summary(f_mmrm_fit)
```


# Comparison 

...


<!--
# References {.unnumbered}

## Literature {.unnumbered}

...


&nbsp;

<div id="refs"></div>

&nbsp;



## Session info {.unnumbered}

```{r citation_session, echo=TRUE, eval=TRUE, message=FALSE}
sessionInfo()
```

-->
