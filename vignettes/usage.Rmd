---
title: "Usage"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



A mixed model of repeated measures (MMRM) analyzes longitudinal clinical trial data. In a longitudinal dataset, there are multiple patients, and each patient has multiple observations at a common set of discrete points in time.

# Data

To use the `brms.mmrm` package, begin with a longitudinal dataset with one row per patient observation and columns for the response variable, treatment group indicator, discrete time point indicator, patient ID variable, and optional baseline covariates such as age and region. If you do not have a real dataset of your own, you can simulate one from the package. The following dataset has the raw response variable, the  essential factor variables, and continuous baseline covariates.^[Covariates can be categorical too.] In general, the outcome variable can either be the raw response or change from baseline.


```r
library(brms.mmrm)
library(dplyr)
library(magrittr)
set.seed(0L)
raw_data <- brm_simulate_simple(
  n_group = 3,
  n_patient = 100,
  n_time = 4
) %>%
  extract2("data") %>%
  brm_simulate_continuous(c("biomarker1", "biomarker2", "biomarker3"))

raw_data
#> # A tibble: 1,200 × 7
#>    response group time  patient biomarker1 biomarker2 biomarker3
#>       <dbl> <chr> <chr> <chr>        <dbl>      <dbl>      <dbl>
#>  1    1.11  grou… time… patien…      1.31      -0.361      1.52 
#>  2    2.15  grou… time… patien…      1.31      -0.361      1.52 
#>  3    2.54  grou… time… patien…      1.31      -0.361      1.52 
#>  4   -1.73  grou… time… patien…      1.31      -0.361      1.52 
#>  5   -0.180 grou… time… patien…      0.107     -2.44      -0.139
#>  6    0.626 grou… time… patien…      0.107     -2.44      -0.139
#>  7   -0.221 grou… time… patien…      0.107     -2.44      -0.139
#>  8   -1.53  grou… time… patien…      0.107     -2.44      -0.139
#>  9    0.393 grou… time… patien…      1.44      -0.419     -1.54 
#> 10    0.442 grou… time… patien…      1.44      -0.419     -1.54 
#> # ℹ 1,190 more rows
```

Next, create a special classed dataset that the package will recognize. The classed data object contains a pre-processed version of the data, along with attributes to declare the outcome variable, whether the outcome is response or change from baseline, the treatment group variable, the discrete time point variable, control group, baseline time point, and the covariates selected for analysis.


```r
data <- brm_data(
  data = raw_data,
  outcome = "response",
  role = "response",
  group = "group",
  patient = "patient",
  time = "time",
  covariates = c("biomarker1", "biomarker2"),
  level_control = "group_1",
  level_baseline = "time_1"
)

data
#> # A tibble: 1,200 × 6
#>    response group   time   patient     biomarker1 biomarker2
#>       <dbl> <chr>   <chr>  <chr>            <dbl>      <dbl>
#>  1    1.11  group_1 time_1 patient_1        1.31      -0.361
#>  2    2.15  group_1 time_2 patient_1        1.31      -0.361
#>  3    2.54  group_1 time_3 patient_1        1.31      -0.361
#>  4   -1.73  group_1 time_4 patient_1        1.31      -0.361
#>  5   -0.180 group_1 time_1 patient_10       0.107     -2.44 
#>  6    0.626 group_1 time_2 patient_10       0.107     -2.44 
#>  7   -0.221 group_1 time_3 patient_10       0.107     -2.44 
#>  8   -1.53  group_1 time_4 patient_10       0.107     -2.44 
#>  9    0.393 group_1 time_1 patient_100      1.44      -0.419
#> 10    0.442 group_1 time_2 patient_100      1.44      -0.419
#> # ℹ 1,190 more rows

class(data)
#> [1] "brm_data"   "tbl_df"     "tbl"        "data.frame"

roles <- attributes(data)
roles$row.names <- NULL
str(roles)
#> List of 14
#>  $ names             : chr [1:6] "response" "group" "time" "patient" ...
#>  $ class             : chr [1:4] "brm_data" "tbl_df" "tbl" "data.frame"
#>  $ brm_outcome       : chr "response"
#>  $ brm_role          : chr "response"
#>  $ brm_group         : chr "group"
#>  $ brm_time          : chr "time"
#>  $ brm_patient       : chr "patient"
#>  $ brm_covariates    : chr [1:2] "biomarker1" "biomarker2"
#>  $ brm_level_control : chr "group_1"
#>  $ brm_level_baseline: chr "time_1"
#>  $ brm_levels_group  : chr [1:3] "group_1" "group_2" "group_3"
#>  $ brm_levels_time   : chr [1:4] "time_1" "time_2" "time_3" "time_4"
#>  $ brm_labels_group  : chr [1:3] "group_1" "group_2" "group_3"
#>  $ brm_labels_time   : chr [1:4] "time_1" "time_2" "time_3" "time_4"
```

# Formula

Next, choose a `brms` model formula for the fixed effect and variance parameters. The `brm_formula()` function from `brms.mmrm` makes this process easier. A cell means parameterization for this particular model can be expressed as follows. It specifies one fixed effect parameter for each combination of treatment group and time point, and it makes the specification of informative priors straightforward through the `prior` argument of `brm_model()`.


```r
brm_formula(
  data = data,
  intercept = FALSE,
  effect_baseline = FALSE,
  effect_group = FALSE,
  effect_time = FALSE,
  interaction_baseline = FALSE,
  interaction_group = TRUE
)
#> response ~ 0 + group:time + biomarker1 + biomarker2 + unstr(time = time, gr = patient) 
#> sigma ~ 0 + time
```

For the purposes of our example, we choose a fully parameterized analysis of the raw response.


```r
formula <- brm_formula(
  data = data,
  intercept = TRUE,
  effect_baseline = FALSE,
  effect_group = TRUE,
  effect_time = TRUE,
  interaction_baseline = FALSE,
  interaction_group = TRUE
)

formula
#> response ~ time + group + group:time + biomarker1 + biomarker2 + unstr(time = time, gr = patient) 
#> sigma ~ 0 + time
```

# Priors

Some analyses require informative priors, others require non-informative ones. Please use [`brms`](https://paul-buerkner.github.io/brms/) to construct a prior suitable for your analysis. The [`brms`](https://paul-buerkner.github.io/brms/) package has documentation on how its default priors are constructed and how to set your own priors. Once you have an R object that represents the joint prior distribution of your model, you can pass it to the `brm_model()` function described below. The `get_prior()` function shows the default priors for a given dataset and model formula.


```r
brms::get_prior(data = data, formula = formula)
#>                   prior     class                    coef group
#>                  (flat)         b                              
#>                  (flat)         b              biomarker1      
#>                  (flat)         b              biomarker2      
#>                  (flat)         b            groupgroup_2      
#>                  (flat)         b            groupgroup_3      
#>                  (flat)         b              timetime_2      
#>                  (flat)         b timetime_2:groupgroup_2      
#>                  (flat)         b timetime_2:groupgroup_3      
#>                  (flat)         b              timetime_3      
#>                  (flat)         b timetime_3:groupgroup_2      
#>                  (flat)         b timetime_3:groupgroup_3      
#>                  (flat)         b              timetime_4      
#>                  (flat)         b timetime_4:groupgroup_2      
#>                  (flat)         b timetime_4:groupgroup_3      
#>                  lkj(1)   cortime                              
#>  student_t(3, 0.9, 2.5) Intercept                              
#>                  (flat)         b                              
#>                  (flat)         b              timetime_1      
#>                  (flat)         b              timetime_2      
#>                  (flat)         b              timetime_3      
#>                  (flat)         b              timetime_4      
#>  resp  dpar nlpar lb ub       source
#>                              default
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                         (vectorized)
#>                              default
#>                              default
#>       sigma                  default
#>       sigma             (vectorized)
#>       sigma             (vectorized)
#>       sigma             (vectorized)
#>       sigma             (vectorized)
```

# Model

To run an MMRM, use the `brm_model()` function. This function calls `brms::brm()` behind the scenes, using the formula and prior you set in the `formula` and `prior` arguments.


```r
model <- brm_model(data = data, formula = formula, refresh = 0)
```



The result is a `brms` model object.


```r
model
#>  Family: gaussian 
#>   Links: mu = identity; sigma = log 
#> Formula: response ~ time + group + group:time + biomarker1 + biomarker2 + unstr(time = time, gr = patient) 
#>          sigma ~ 0 + time
#>    Data: data (Number of observations: 1200) 
#>   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
#>          total post-warmup draws = 4000
#> 
#> Correlation Structures:
#>                        Estimate
#> cortime(time_1,time_2)     0.49
#> cortime(time_1,time_3)    -0.49
#> cortime(time_2,time_3)    -0.26
#> cortime(time_1,time_4)    -0.15
#> cortime(time_2,time_4)     0.14
#> cortime(time_3,time_4)     0.08
#>                        Est.Error
#> cortime(time_1,time_2)      0.04
#> cortime(time_1,time_3)      0.04
#> cortime(time_2,time_3)      0.06
#> cortime(time_1,time_4)      0.05
#> cortime(time_2,time_4)      0.06
#> cortime(time_3,time_4)      0.06
#>                        l-95% CI
#> cortime(time_1,time_2)     0.40
#> cortime(time_1,time_3)    -0.57
#> cortime(time_2,time_3)    -0.37
#> cortime(time_1,time_4)    -0.25
#> cortime(time_2,time_4)     0.03
#> cortime(time_3,time_4)    -0.04
#>                        u-95% CI
#> cortime(time_1,time_2)     0.58
#> cortime(time_1,time_3)    -0.40
#> cortime(time_2,time_3)    -0.15
#> cortime(time_1,time_4)    -0.04
#> cortime(time_2,time_4)     0.25
#> cortime(time_3,time_4)     0.19
#>                        Rhat
#> cortime(time_1,time_2) 1.00
#> cortime(time_1,time_3) 1.00
#> cortime(time_2,time_3) 1.00
#> cortime(time_1,time_4) 1.00
#> cortime(time_2,time_4) 1.00
#> cortime(time_3,time_4) 1.00
#>                        Bulk_ESS
#> cortime(time_1,time_2)     5073
#> cortime(time_1,time_3)     5197
#> cortime(time_2,time_3)     5131
#> cortime(time_1,time_4)     6564
#> cortime(time_2,time_4)     5987
#> cortime(time_3,time_4)     6469
#>                        Tail_ESS
#> cortime(time_1,time_2)     3186
#> cortime(time_1,time_3)     3348
#> cortime(time_2,time_3)     2786
#> cortime(time_1,time_4)     3319
#> cortime(time_2,time_4)     3071
#> cortime(time_3,time_4)     3246
#> 
#> Population-Level Effects: 
#>                         Estimate
#> Intercept                  -0.20
#> timetime_2                  1.32
#> timetime_3                  0.51
#> timetime_4                 -1.44
#> groupgroup_2                1.35
#> groupgroup_3                1.55
#> biomarker1                  0.02
#> biomarker2                  0.02
#> timetime_2:groupgroup_2     0.04
#> timetime_3:groupgroup_2    -0.17
#> timetime_4:groupgroup_2    -0.08
#> timetime_2:groupgroup_3     0.02
#> timetime_3:groupgroup_3    -0.19
#> timetime_4:groupgroup_3    -0.27
#> sigma_timetime_1           -0.06
#> sigma_timetime_2            0.08
#> sigma_timetime_3            0.09
#> sigma_timetime_4            0.26
#>                         Est.Error
#> Intercept                    0.10
#> timetime_2                   0.10
#> timetime_3                   0.18
#> timetime_4                   0.18
#> groupgroup_2                 0.13
#> groupgroup_3                 0.13
#> biomarker1                   0.03
#> biomarker2                   0.03
#> timetime_2:groupgroup_2      0.14
#> timetime_3:groupgroup_2      0.25
#> timetime_4:groupgroup_2      0.25
#> timetime_2:groupgroup_3      0.14
#> timetime_3:groupgroup_3      0.25
#> timetime_4:groupgroup_3      0.25
#> sigma_timetime_1             0.04
#> sigma_timetime_2             0.04
#> sigma_timetime_3             0.04
#> sigma_timetime_4             0.04
#>                         l-95% CI
#> Intercept                  -0.39
#> timetime_2                  1.12
#> timetime_3                  0.17
#> timetime_4                 -1.79
#> groupgroup_2                1.09
#> groupgroup_3                1.28
#> biomarker1                 -0.03
#> biomarker2                 -0.03
#> timetime_2:groupgroup_2    -0.24
#> timetime_3:groupgroup_2    -0.65
#> timetime_4:groupgroup_2    -0.57
#> timetime_2:groupgroup_3    -0.26
#> timetime_3:groupgroup_3    -0.68
#> timetime_4:groupgroup_3    -0.76
#> sigma_timetime_1           -0.14
#> sigma_timetime_2           -0.00
#> sigma_timetime_3            0.01
#> sigma_timetime_4            0.18
#>                         u-95% CI
#> Intercept                  -0.01
#> timetime_2                  1.52
#> timetime_3                  0.86
#> timetime_4                 -1.10
#> groupgroup_2                1.62
#> groupgroup_3                1.81
#> biomarker1                  0.07
#> biomarker2                  0.07
#> timetime_2:groupgroup_2     0.31
#> timetime_3:groupgroup_2     0.32
#> timetime_4:groupgroup_2     0.41
#> timetime_2:groupgroup_3     0.32
#> timetime_3:groupgroup_3     0.29
#> timetime_4:groupgroup_3     0.20
#> sigma_timetime_1            0.02
#> sigma_timetime_2            0.16
#> sigma_timetime_3            0.17
#> sigma_timetime_4            0.34
#>                         Rhat
#> Intercept               1.00
#> timetime_2              1.00
#> timetime_3              1.00
#> timetime_4              1.00
#> groupgroup_2            1.00
#> groupgroup_3            1.00
#> biomarker1              1.00
#> biomarker2              1.00
#> timetime_2:groupgroup_2 1.00
#> timetime_3:groupgroup_2 1.00
#> timetime_4:groupgroup_2 1.00
#> timetime_2:groupgroup_3 1.00
#> timetime_3:groupgroup_3 1.00
#> timetime_4:groupgroup_3 1.00
#> sigma_timetime_1        1.00
#> sigma_timetime_2        1.00
#> sigma_timetime_3        1.00
#> sigma_timetime_4        1.00
#>                         Bulk_ESS
#> Intercept                   1462
#> timetime_2                  1941
#> timetime_3                  1592
#> timetime_4                  1612
#> groupgroup_2                1514
#> groupgroup_3                1572
#> biomarker1                  6023
#> biomarker2                  6342
#> timetime_2:groupgroup_2     2187
#> timetime_3:groupgroup_2     1692
#> timetime_4:groupgroup_2     1811
#> timetime_2:groupgroup_3     2210
#> timetime_3:groupgroup_3     1531
#> timetime_4:groupgroup_3     1739
#> sigma_timetime_1            4527
#> sigma_timetime_2            4901
#> sigma_timetime_3            5446
#> sigma_timetime_4            6614
#>                         Tail_ESS
#> Intercept                   1836
#> timetime_2                  2866
#> timetime_3                  1970
#> timetime_4                  2118
#> groupgroup_2                2403
#> groupgroup_3                2442
#> biomarker1                  2983
#> biomarker2                  2646
#> timetime_2:groupgroup_2     2723
#> timetime_3:groupgroup_2     2214
#> timetime_4:groupgroup_2     2320
#> timetime_2:groupgroup_3     2913
#> timetime_3:groupgroup_3     2200
#> timetime_4:groupgroup_3     2627
#> sigma_timetime_1            3156
#> sigma_timetime_2            2810
#> sigma_timetime_3            3485
#> sigma_timetime_4            2952
#> 
#> Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
#> and Tail_ESS are effective sample size measures, and Rhat is the potential
#> scale reduction factor on split chains (at convergence, Rhat = 1).
```

# Marginals

Regardless of the choice of fixed effects formula, `brms.mmrm` performs inference on the marginal distributions at each treatment group and time point of the mean of the following quantities:

1. Response.
2. Change from baseline, if you set `role` to `"change"` in `brm_data()`.
3. Treatment difference, in terms of change from baseline.
4. Effect size: treatment difference divided by the residual standard deviation.

To derive posterior draws of these marginals, use the `brm_marginal_draws()` function.


```r
draws <- brm_marginal_draws(model = model, data = data)

draws
#> $response
#> # A draws_df: 1000 iterations, 4 chains, and 12 variables
#>    group_1|time_1
#> 1          -0.206
#> 2          -0.134
#> 3          -0.148
#> 4          -0.132
#> 5          -0.227
#> 6          -0.079
#> 7          -0.235
#> 8          -0.211
#> 9          -0.210
#> 10         -0.263
#>    group_2|time_1
#> 1            1.12
#> 2            1.00
#> 3            1.22
#> 4            1.13
#> 5            1.25
#> 6            1.16
#> 7            0.96
#> 8            0.98
#> 9            1.34
#> 10           1.02
#>    group_3|time_1
#> 1             1.4
#> 2             1.5
#> 3             1.3
#> 4             1.3
#> 5             1.2
#> 6             1.5
#> 7             1.3
#> 8             1.4
#> 9             1.5
#> 10            1.3
#>    group_1|time_2
#> 1            1.07
#> 2            1.22
#> 3            1.06
#> 4            1.25
#> 5            0.99
#> 6            1.21
#> 7            1.16
#> 8            1.14
#> 9            1.34
#> 10           1.22
#>    group_2|time_2
#> 1             2.3
#> 2             2.5
#> 3             2.4
#> 4             2.8
#> 5             2.5
#> 6             2.5
#> 7             2.4
#> 8             2.4
#> 9             2.7
#> 10            2.3
#>    group_3|time_2
#> 1             2.7
#> 2             2.7
#> 3             2.7
#> 4             2.7
#> 5             2.3
#> 6             2.9
#> 7             2.8
#> 8             2.8
#> 9             2.7
#> 10            2.8
#>    group_1|time_3
#> 1            0.24
#> 2            0.40
#> 3            0.23
#> 4            0.47
#> 5            0.41
#> 6            0.36
#> 7            0.48
#> 8            0.45
#> 9            0.28
#> 10           0.44
#>    group_2|time_3
#> 1             1.4
#> 2             1.6
#> 3             1.3
#> 4             1.5
#> 5             1.5
#> 6             1.5
#> 7             1.7
#> 8             1.6
#> 9             1.3
#> 10            1.5
#> # ... with 3990 more draws, and 4 more variables
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $change
#> # A draws_df: 1000 iterations, 4 chains, and 9 variables
#>    group_1|time_2
#> 1             1.3
#> 2             1.4
#> 3             1.2
#> 4             1.4
#> 5             1.2
#> 6             1.3
#> 7             1.4
#> 8             1.3
#> 9             1.6
#> 10            1.5
#>    group_1|time_3
#> 1            0.45
#> 2            0.54
#> 3            0.37
#> 4            0.60
#> 5            0.63
#> 6            0.44
#> 7            0.72
#> 8            0.66
#> 9            0.49
#> 10           0.70
#>    group_1|time_4
#> 1            -1.5
#> 2            -1.3
#> 3            -1.6
#> 4            -1.4
#> 5            -1.5
#> 6            -1.3
#> 7            -1.3
#> 8            -1.3
#> 9            -1.4
#> 10           -1.2
#>    group_2|time_2
#> 1             1.2
#> 2             1.5
#> 3             1.1
#> 4             1.7
#> 5             1.2
#> 6             1.3
#> 7             1.5
#> 8             1.4
#> 9             1.4
#> 10            1.3
#>    group_2|time_3
#> 1           0.260
#> 2           0.569
#> 3           0.101
#> 4           0.370
#> 5           0.230
#> 6           0.367
#> 7           0.756
#> 8           0.644
#> 9          -0.024
#> 10          0.492
#>    group_2|time_4
#> 1            -1.5
#> 2            -1.4
#> 3            -1.8
#> 4            -1.3
#> 5            -1.8
#> 6            -1.4
#> 7            -1.3
#> 8            -1.4
#> 9            -1.7
#> 10           -1.4
#>    group_3|time_2
#> 1             1.3
#> 2             1.2
#> 3             1.3
#> 4             1.4
#> 5             1.1
#> 6             1.4
#> 7             1.5
#> 8             1.4
#> 9             1.2
#> 10            1.5
#>    group_3|time_3
#> 1           0.262
#> 2           0.243
#> 3           0.355
#> 4           0.230
#> 5           0.481
#> 6           0.096
#> 7           0.335
#> 8           0.369
#> 9           0.227
#> 10          0.395
#> # ... with 3990 more draws, and 1 more variables
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $difference
#> # A draws_df: 1000 iterations, 4 chains, and 6 variables
#>    group_2|time_2
#> 1          -0.059
#> 2           0.172
#> 3          -0.076
#> 4           0.280
#> 5          -0.013
#> 6           0.042
#> 7           0.080
#> 8           0.035
#> 9          -0.193
#> 10         -0.198
#>    group_2|time_3
#> 1          -0.190
#> 2           0.033
#> 3          -0.273
#> 4          -0.234
#> 5          -0.404
#> 6          -0.072
#> 7           0.040
#> 8          -0.012
#> 9          -0.512
#> 10         -0.208
#>    group_2|time_4
#> 1           0.019
#> 2          -0.056
#> 3          -0.191
#> 4           0.122
#> 5          -0.314
#> 6          -0.098
#> 7           0.050
#> 8          -0.031
#> 9          -0.286
#> 10         -0.178
#>    group_3|time_2
#> 1         0.02699
#> 2        -0.12298
#> 3         0.13425
#> 4        -0.01787
#> 5        -0.08279
#> 6         0.10895
#> 7         0.09175
#> 8         0.07055
#> 9        -0.31149
#> 10       -0.00073
#>    group_3|time_3
#> 1           -0.19
#> 2           -0.29
#> 3           -0.02
#> 4           -0.37
#> 5           -0.15
#> 6           -0.34
#> 7           -0.38
#> 8           -0.29
#> 9           -0.26
#> 10          -0.30
#>    group_3|time_4
#> 1          -0.335
#> 2          -0.402
#> 3          -0.099
#> 4          -0.506
#> 5          -0.160
#> 6          -0.370
#> 7          -0.262
#> 8          -0.326
#> 9          -0.400
#> 10         -0.320
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $effect
#> # A draws_df: 1000 iterations, 4 chains, and 6 variables
#>    group_2|time_2
#> 1          -0.057
#> 2           0.164
#> 3          -0.069
#> 4           0.262
#> 5          -0.012
#> 6           0.038
#> 7           0.071
#> 8           0.031
#> 9          -0.174
#> 10         -0.165
#>    group_2|time_3
#> 1          -0.177
#> 2           0.030
#> 3          -0.246
#> 4          -0.216
#> 5          -0.376
#> 6          -0.066
#> 7           0.038
#> 8          -0.012
#> 9          -0.449
#> 10         -0.184
#>    group_2|time_4
#> 1           0.015
#> 2          -0.045
#> 3          -0.146
#> 4           0.092
#> 5          -0.237
#> 6          -0.078
#> 7           0.038
#> 8          -0.025
#> 9          -0.208
#> 10         -0.138
#>    group_3|time_2
#> 1         0.02600
#> 2        -0.11734
#> 3         0.12200
#> 4        -0.01670
#> 5        -0.07554
#> 6         0.09773
#> 7         0.08133
#> 8         0.06257
#> 9        -0.28115
#> 10       -0.00061
#>    group_3|time_3
#> 1          -0.175
#> 2          -0.265
#> 3          -0.018
#> 4          -0.345
#> 5          -0.142
#> 6          -0.317
#> 7          -0.362
#> 8          -0.271
#> 9          -0.230
#> 10         -0.269
#>    group_3|time_4
#> 1          -0.261
#> 2          -0.327
#> 3          -0.076
#> 4          -0.381
#> 5          -0.120
#> 6          -0.293
#> 7          -0.201
#> 8          -0.256
#> 9          -0.291
#> 10         -0.247
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
```

If you need samples from these marginals averaged across time points, e.g. an "overall effect size", `brm_marginal_draws_average()` can average the draws above across discrete time points (either all or a user-defined subset).


```r
brm_marginal_draws_average(draws = draws, data = data)
#> $response
#> # A draws_df: 1000 iterations, 4 chains, and 3 variables
#>    group_1|average
#> 1          -0.1501
#> 2           0.0057
#> 3          -0.1500
#> 4           0.0159
#> 5          -0.1307
#> 6           0.0184
#> 7          -0.0390
#> 8          -0.0416
#> 9          -0.0532
#> 10         -0.0290
#>    group_2|average
#> 1              1.1
#> 2              1.2
#> 3              1.1
#> 4              1.3
#> 5              1.2
#> 6              1.2
#> 7              1.2
#> 8              1.1
#> 9              1.3
#> 10             1.1
#>    group_3|average
#> 1              1.3
#> 2              1.4
#> 3              1.3
#> 4              1.3
#> 5              1.2
#> 6              1.4
#> 7              1.4
#> 8              1.4
#> 9              1.4
#> 10             1.4
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $change
#> # A draws_df: 1000 iterations, 4 chains, and 3 variables
#>    group_1|average
#> 1           0.0748
#> 2           0.1864
#> 3          -0.0021
#> 4           0.1967
#> 5           0.1288
#> 6           0.1301
#> 7           0.2612
#> 8           0.2261
#> 9           0.2095
#> 10          0.3126
#>    group_2|average
#> 1          -0.0018
#> 2           0.2360
#> 3          -0.1820
#> 4           0.2526
#> 5          -0.1151
#> 6           0.0875
#> 7           0.3179
#> 8           0.2231
#> 9          -0.1209
#> 10          0.1177
#>    group_3|average
#> 1          -0.0907
#> 2          -0.0861
#> 3           0.0031
#> 4          -0.1024
#> 5          -0.0029
#> 6          -0.0714
#> 7           0.0773
#> 8           0.0448
#> 9          -0.1151
#> 10          0.1042
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $difference
#> # A draws_df: 1000 iterations, 4 chains, and 2 variables
#>    group_2|average
#> 1          -0.0766
#> 2           0.0496
#> 3          -0.1800
#> 4           0.0560
#> 5          -0.2439
#> 6          -0.0426
#> 7           0.0567
#> 8          -0.0031
#> 9          -0.3304
#> 10         -0.1949
#>    group_3|average
#> 1          -0.1655
#> 2          -0.2725
#> 3           0.0051
#> 4          -0.2991
#> 5          -0.1317
#> 6          -0.2015
#> 7          -0.1839
#> 8          -0.1813
#> 9          -0.3246
#> 10         -0.2084
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
#> 
#> $effect
#> # A draws_df: 1000 iterations, 4 chains, and 2 variables
#>    group_2|average
#> 1          -0.0727
#> 2           0.0494
#> 3          -0.1536
#> 4           0.0459
#> 5          -0.2082
#> 6          -0.0354
#> 7           0.0491
#> 8          -0.0019
#> 9          -0.2772
#> 10         -0.1623
#>    group_3|average
#> 1          -0.1367
#> 2          -0.2363
#> 3           0.0094
#> 4          -0.2475
#> 5          -0.1126
#> 6          -0.1707
#> 7          -0.1604
#> 8          -0.1549
#> 9          -0.2674
#> 10         -0.1724
#> # ... with 3990 more draws
#> # ... hidden reserved variables {'.chain', '.iteration', '.draw'}
```

The `brm_marginal_summaries()` function produces posterior summaries of these marginals, and it includes the Monte Carlo standard error (MCSE) of each estimate.


```r
summaries <- brm_marginal_summaries(draws, level = 0.95)

summaries
#> # A tibble: 165 × 6
#>    marginal statistic group  
#>    <chr>    <chr>     <chr>  
#>  1 change   lower     group_1
#>  2 change   lower     group_1
#>  3 change   lower     group_1
#>  4 change   lower     group_2
#>  5 change   lower     group_2
#>  6 change   lower     group_2
#>  7 change   lower     group_3
#>  8 change   lower     group_3
#>  9 change   lower     group_3
#> 10 change   mean      group_1
#> # ℹ 155 more rows
#> # ℹ 3 more variables:
#> #   time <chr>, value <dbl>,
#> #   mcse <dbl>
```

The `brm_marginal_probabilities()` function shows posterior probabilities of the form, 

$$
\begin{aligned}
\text{Prob}(\text{treatment effect} > \text{threshold})
\end{aligned}
$$

or 

$$
\begin{aligned}
\text{Prob}(\text{treatment effect} < \text{threshold})
\end{aligned}
$$


```r
brm_marginal_probabilities(
  draws = draws,
  threshold = c(-0.1, 0.1),
  direction = c("greater", "less")
)
#> # A tibble: 12 × 5
#>    direction threshold group  
#>    <chr>         <dbl> <chr>  
#>  1 greater        -0.1 group_2
#>  2 greater        -0.1 group_2
#>  3 greater        -0.1 group_2
#>  4 greater        -0.1 group_3
#>  5 greater        -0.1 group_3
#>  6 greater        -0.1 group_3
#>  7 less            0.1 group_2
#>  8 less            0.1 group_2
#>  9 less            0.1 group_2
#> 10 less            0.1 group_3
#> 11 less            0.1 group_3
#> 12 less            0.1 group_3
#> # ℹ 2 more variables:
#> #   time <chr>, value <dbl>
```

Finally, the `brm_marignals_data()` computes marginal means and confidence intervals on the response variable in the data, along with other summary statistics.


```r
summaries_data <- brm_marginal_data(data = data, level = 0.95)

summaries_data
#> # A tibble: 84 × 4
#>    statistic group   time  
#>    <chr>     <chr>   <chr> 
#>  1 lower     group_1 time_1
#>  2 lower     group_1 time_2
#>  3 lower     group_1 time_3
#>  4 lower     group_1 time_4
#>  5 lower     group_2 time_1
#>  6 lower     group_2 time_2
#>  7 lower     group_2 time_3
#>  8 lower     group_2 time_4
#>  9 lower     group_3 time_1
#> 10 lower     group_3 time_2
#> # ℹ 74 more rows
#> # ℹ 1 more variable:
#> #   value <dbl>
```

# Visualization

The `brm_plot_compare()` function compares means and intervals from many different models and data sources in the same plot. First, we need the marginals of the data.


```r
brm_plot_compare(
  data = summaries_data,
  model1 = summaries,
  model2 = summaries
)
```

![plot of chunk response](usage/response-1.png)

If you omit the marginals of the data, you can show inference on change from baseline or the treatment effect.


```r
brm_plot_compare(
  model1 = summaries,
  model2 = summaries,
  marginal = "difference" # treatment effect
)
```

![plot of chunk difference](usage/difference-1.png)

Finally, `brm_plot_draws()` can plot the posterior draws of the response, change from baseline, or treatment difference.


```r
brm_plot_draws(draws = draws$difference)
```

![plot of chunk draws](usage/draws-1.png)
